# 酒店业BI报告平台 - 前端开发指南

## 1. 项目概述

酒店业BI报告平台是一个自动化、智能化、可视化的数据分析平台，旨在帮助酒店从业者从重复性的报告工作中解放出来，专注于数据背后的洞察和业务决策。该平台支持数据上传、KPI自动计算、AI智能分析以及双格式报告（PDF和PPT）生成。

## 2. 技术栈

- **后端框架**：FastAPI
- **数据库**：PostgreSQL
- **数据库迁移**：Alembic
- **缓存与任务队列**：Redis + Celery
- **文件存储**：MinIO
- **AI服务**：DeepSeek API
- **前端框架**：Vue 3 (待实现)

## 3. API接口概览

后端API采用RESTful风格设计，基础URL为`/api/v1`。所有API返回JSON格式数据。

### 3.1 API路由模块

| 模块 | 路径 | 描述 |
|------|------|------|
| 上传 | `/api/v1/upload` | 处理文件上传相关操作 |
| 数据 | `/api/v1/data` | 提供数据查询和管理功能 |
| 报告 | `/api/v1/reports` | 管理报告生成和查询 |
| 仪表盘 | `/api/v1/dashboard` | 提供仪表盘数据 |
| 任务 | `/api/v1/tasks` | 管理异步任务 |

### 3.2 主要API端点

#### 上传模块

- `POST /api/v1/upload/file` - 上传数据文件
- `GET /api/v1/upload/templates` - 获取上传模板

#### 数据模块

- `GET /api/v1/data/hotels` - 获取酒店列表
- `GET /api/v1/data/hotels/{hotel_id}` - 获取酒店详情
- `GET /api/v1/data/metrics` - 获取指标数据

#### 报告模块

- `POST /api/v1/reports/generate` - 创建报告生成请求
- `GET /api/v1/reports` - 获取报告列表
- `GET /api/v1/reports/{report_id}` - 获取报告详情
- `GET /api/v1/reports/{report_id}/download` - 下载报告文件

#### 仪表盘模块

- `GET /api/v1/dashboard/summary` - 获取仪表盘摘要数据
- `GET /api/v1/dashboard/trends` - 获取趋势分析数据
- `GET /api/v1/dashboard/comparison` - 获取比较分析数据

#### 任务模块

- `GET /api/v1/tasks` - 获取任务列表
- `GET /api/v1/tasks/{task_id}` - 获取任务状态
- `DELETE /api/v1/tasks/{task_id}` - 取消任务

## 4. 数据模型

### 4.1 核心数据结构

#### 酒店数据 (HotelData)

```typescript
interface HotelData {
  id: number;
  hotel_name: string;
  location?: string;
  room_count?: number;
  rooms_occupied?: number;
  occupancy_rate?: number;
  revenue?: number;
  adr?: number;  // Average Daily Rate (平均房价)
  revpar?: number;  // Revenue Per Available Room (每可用房收入)
  date_recorded?: string;  // YYYY-MM-DD
  created_at: string;  // ISO日期时间
  updated_at: string;  // ISO日期时间
}
```

#### KPI指标 (KPIMetric)

```typescript
interface KPIMetric {
  id: number;
  hotel_id: number;
  metric_name: string;
  metric_value?: number;
  metric_type?: string;
  period_type?: string;  // 'daily', 'weekly', 'monthly', 'yearly'
  period_start?: string;  // YYYY-MM-DD
  period_end?: string;  // YYYY-MM-DD
}
```

#### 报告 (Report)

```typescript
interface Report {
  id: number;
  title: string;
  report_type: string;  // 'analysis', 'comparison', 'forecast'
  status: string;  // 'pending', 'processing', 'completed', 'failed'
  created_at: string;  // ISO日期时间
  completed_at?: string;  // ISO日期时间
  file_paths?: {
    pdf?: string;
    ppt?: string;
  };
}
```

#### 任务状态 (TaskStatus)

```typescript
interface TaskStatus {
  id: number;
  task_id: string;  // Celery任务ID
  task_type: string;
  status: string;  // 'pending', 'running', 'completed', 'failed'
  progress: number;  // 0-100
  started_at?: string;  // ISO日期时间
  completed_at?: string;  // ISO日期时间
  error_message?: string;
}
```

### 4.2 请求和响应模型

#### 请求模型

- **文件上传请求**：指定文件类型和覆盖选项
- **日期范围请求**：指定开始和结束日期
- **KPI计算请求**：指定酒店ID、指标列表和日期范围
- **报告生成请求**：指定报告标题、类型、酒店ID列表、日期范围和输出格式

#### 响应模型

- **基础响应**：包含成功状态和消息
- **错误响应**：包含错误信息和代码
- **分页响应**：包含数据项、总数、页码等信息
- **文件URL响应**：包含文件URL和过期时间

## 5. 前端开发建议

### 5.1 页面规划

建议实现以下核心页面：

1. **登录页面**：用户认证
2. **数据上传页面**：文件上传和数据导入
3. **仪表盘页面**：KPI摘要、趋势图表和比较分析
4. **报告管理页面**：报告生成和下载
5. **任务监控页面**：异步任务状态和进度

### 5.2 组件设计

建议开发以下核心组件：

1. **文件上传组件**：支持拖放和文件选择
2. **KPI卡片组件**：显示关键指标和变化趋势
3. **趋势图表组件**：使用ECharts或Chart.js展示数据趋势
4. **报告预览组件**：PDF和PPT预览
5. **任务进度组件**：显示任务状态和进度条

### 5.3 状态管理

建议使用Pinia或Vuex进行状态管理，主要存储：

1. **用户信息**：当前登录用户和权限
2. **筛选条件**：日期范围、酒店选择等
3. **仪表盘数据**：KPI指标和图表数据
4. **任务状态**：长时间运行任务的状态和进度

### 5.4 API调用

建议使用Axios进行API调用，并创建API客户端模块：

```typescript
// api/client.ts
import axios from 'axios';

const apiClient = axios.create({
  baseURL: '/api/v1',
  headers: {
    'Content-Type': 'application/json',
  },
});

// 请求拦截器：添加认证信息
apiClient.interceptors.request.use(config => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// 响应拦截器：处理错误
apiClient.interceptors.response.use(
  response => response,
  error => {
    if (error.response && error.response.status === 401) {
      // 处理未授权错误
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

export default apiClient;
```

### 5.5 实时更新

对于长时间运行的任务（如报告生成），建议实现轮询或WebSocket连接以获取实时更新：

```typescript
// 轮询示例
function pollTaskStatus(taskId: string, callback: (status: TaskStatus) => void) {
  const intervalId = setInterval(async () => {
    try {
      const response = await apiClient.get(`/tasks/${taskId}`);
      const status = response.data;
      
      callback(status);
      
      if (['completed', 'failed'].includes(status.status)) {
        clearInterval(intervalId);
      }
    } catch (error) {
      console.error('Failed to fetch task status:', error);
      clearInterval(intervalId);
    }
  }, 2000); // 每2秒轮询一次
  
  return () => clearInterval(intervalId); // 返回清理函数
}
```

## 6. 开发环境设置

### 6.1 前端开发环境

1. 创建Vue 3项目：
   ```bash
   npm create vue@latest
   ```

2. 安装依赖：
   ```bash
   cd frontend
   npm install
   ```

3. 配置代理（用于开发环境）：
   ```javascript
   // vite.config.js
   export default {
     server: {
       proxy: {
         '/api': {
           target: 'http://localhost:8000',
           changeOrigin: true
         }
       }
     }
   }
   ```

4. 启动开发服务器：
   ```bash
   npm run dev
   ```

### 6.2 与后端集成

后端API服务器默认运行在`http://localhost:8000`，Swagger文档可通过`http://localhost:8000/docs`访问。

## 7. 文档和资源

- API文档：`http://localhost:8000/docs`（Swagger UI）或`http://localhost:8000/redoc`（ReDoc）
- 项目进度表：参考`项目进度表.md`
- 基础设施说明：参考`基础设施搭建说明文档.md`
- 技术框架：参考`智能化酒店业BI报告平台技术框架.md`

## 8. 联系与协作

如有任何问题或需要进一步了解后端API和数据结构，请联系后端开发团队。我们建议前后端团队定期进行同步会议，确保接口定义和数据结构的一致性。

## 技术栈概述

本项目采用现代前端技术栈构建，主要包括：

- **Vue 3**：核心框架，采用Composition API风格开发
- **TypeScript**：提供静态类型检查，提高代码质量和可维护性
- **Element Plus**：UI组件库，提供丰富的界面组件
- **ECharts**：数据可视化图表库，用于展示各类业务指标
- **Vue Router**：路由管理
- **Axios**：HTTP请求库，用于与后端API交互

## 环境要求

- Node.js 16.x 或更高版本
- npm 7.x 或更高版本
- 现代浏览器（Chrome、Firefox、Safari、Edge等）

## 项目设置

### 安装依赖

```bash
cd Hotel\ BI
npm install
```

### 启动开发服务器

```bash
npm run dev
```

开发服务器默认在 `http://localhost:5173` 启动。

### 构建生产版本

```bash
npm run build
```

构建产物将输出到 `dist` 目录。

## 项目结构说明

```
Hotel BI/
├── public/                 # 静态资源
├── src/
│   ├── api/                # API服务
│   │   ├── client.ts       # Axios配置
│   │   └── services.ts     # API服务封装
│   ├── assets/             # 静态资源
│   ├── components/         # 通用组件
│   ├── router/             # 路由配置
│   ├── types/              # TypeScript类型定义
│   │   └── models.ts       # 数据模型类型
│   ├── views/              # 页面组件
│   │   ├── DashboardView.vue  # 仪表盘页面
│   │   ├── LoginView.vue      # 登录页面
│   │   ├── ReportsView.vue    # 报告管理页面
│   │   ├── UploadView.vue     # 数据上传页面
│   │   └── SettingsView.vue   # 系统设置页面
│   ├── App.vue             # 根组件
│   └── main.ts             # 入口文件
├── package.json            # 项目依赖
└── tsconfig.json           # TypeScript配置
```

## 开发规范

### 代码风格

- 使用TypeScript编写所有代码
- 使用Composition API风格开发Vue组件
- 遵循ESLint配置的代码规范
- 组件命名采用PascalCase（如DashboardView）
- 变量命名采用camelCase（如hotelData）

### 组件开发

- 每个组件应有明确的职责，避免过于复杂的组件
- 使用`<script setup>`语法糖简化组件代码
- 使用TypeScript类型定义组件props和状态
- 组件样式使用scoped CSS，避免样式污染

```vue
<script setup lang="ts">
import { ref } from 'vue';

// 类型定义
interface Props {
  title: string;
}

// Props定义
const props = defineProps<Props>();

// 状态管理
const count = ref(0);

// 方法
const increment = () => {
  count.value++;
};
</script>

<template>
  <div class="my-component">
    <h2>{{ props.title }}</h2>
    <p>Count: {{ count }}</p>
    <button @click="increment">Increment</button>
  </div>
</template>

<style scoped>
.my-component {
  padding: 16px;
  border: 1px solid #eee;
}
</style>
```

### API调用

使用封装好的API服务进行后端交互：

```typescript
import { dataService } from '../api/services';

// 获取酒店列表
const fetchHotels = async () => {
  try {
    const hotels = await dataService.getHotels();
    // 处理数据
  } catch (error) {
    console.error('获取酒店列表失败:', error);
    // 错误处理
  }
};
```

### 路由导航

使用Vue Router进行页面导航：

```typescript
import { useRouter } from 'vue-router';

const router = useRouter();

// 导航到仪表盘页面
const goToDashboard = () => {
  router.push('/dashboard');
};

// 带参数导航
const viewReport = (reportId: number) => {
  router.push(`/reports/${reportId}`);
};
```

## 模拟数据机制

为了支持前端开发和演示，系统实现了模拟数据机制。在API调用失败时，会自动回退到使用模拟数据：

```typescript
// 加载KPI数据
const loadKPIData = async () => {
  if (!selectedHotel.value) return;
  
  isLoading.value = true;
  
  try {
    try {
      // 尝试从API获取数据
      kpiMetrics.value = await dataService.getMetrics({
        hotel_id: selectedHotel.value,
        period_type: 'daily',
        start_date: dateRange.value.start,
        end_date: dateRange.value.end
      });
    } catch (error) {
      console.error('无法从API获取指标数据，使用模拟数据', error);
      // 使用模拟数据
      generateMockData();
    }
  } catch (error) {
    console.error('获取指标数据失败:', error);
    ElMessage.error('加载指标数据失败');
  } finally {
    isLoading.value = false;
  }
};
```

## 数据可视化

使用ECharts创建图表：

```typescript
// 图表选项
const occupancyChartOption = ref({
  title: {
    text: '入住率趋势',
    left: 'center'
  },
  tooltip: {
    trigger: 'axis',
    formatter: '{b}: {c}%'
  },
  xAxis: {
    type: 'category',
    data: [] as string[],
  },
  yAxis: {
    type: 'value',
    min: 0,
    max: 100,
    axisLabel: {
      formatter: '{value}%'
    }
  },
  series: [
    {
      name: '入住率',
      type: 'line',
      data: [] as number[],
      smooth: true,
    }
  ]
});

// 更新图表数据
const updateChartData = () => {
  // 处理数据
  occupancyChartOption.value.xAxis.data = dates;
  occupancyChartOption.value.series[0].data = occupancyData;
};
```

## 登录认证

系统使用基于Token的认证机制：

```typescript
// 登录
const login = async () => {
  try {
    const result = await authService.login(username.value, password.value);
    localStorage.setItem('token', result.token);
    router.push('/dashboard');
  } catch (error) {
    ElMessage.error('登录失败，请检查用户名和密码');
  }
};

// 退出登录
const logout = () => {
  localStorage.removeItem('token');
  router.push('/login');
};
```

## 测试账号

开发环境下可使用以下账号登录：

- 用户名：admin
- 密码：admin

## 常见问题

### 1. API连接失败

如果遇到API连接失败，请检查：
- 后端服务是否正常运行
- API地址配置是否正确（在`api/client.ts`中）
- 网络连接是否正常

系统会自动回退到使用模拟数据，所以前端开发不会受到影响。

### 2. 类型错误

如果遇到TypeScript类型错误，请确保：
- 正确导入了类型定义
- 正确定义了变量类型
- 使用了正确的类型断言

### 3. 组件渲染问题

如果组件不正确渲染，请检查：
- Vue开发者工具中的组件层次结构
- 组件的props传递是否正确
- 响应式数据是否正确更新

## 部署指南

### 构建生产版本

```bash
npm run build
```

### 部署到Web服务器

将`dist`目录中的文件部署到Web服务器的根目录。

### 环境变量配置

在生产环境中，可以通过环境变量配置API地址：

```
VITE_API_BASE_URL=https://api.example.com
```

## 贡献指南

1. 创建功能分支：`git checkout -b feature/your-feature-name`
2. 提交更改：`git commit -m 'Add some feature'`
3. 推送到分支：`git push origin feature/your-feature-name`
4. 提交Pull Request

## 联系方式

如有任何问题，请联系项目维护者。 