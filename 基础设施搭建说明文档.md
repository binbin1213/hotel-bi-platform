# 酒店业BI报告平台 - 基础设施搭建说明文档

## 项目概述

酒店业BI报告平台是一个自动化、智能化、可视化的数据分析平台，旨在帮助酒店从业者从重复性的报告工作中解放出来，专注于数据背后的洞察和业务决策。该平台支持数据上传、KPI自动计算、AI智能分析以及双格式报告（PDF和PPT）生成。

## 技术栈

- **后端框架**：FastAPI
- **数据库**：PostgreSQL
- **数据库迁移**：Alembic
- **缓存与任务队列**：Redis + Celery
- **文件存储**：MinIO
- **AI服务**：DeepSeek API
- **前端框架**：Vue 3 (计划中)
- **容器化**：Docker & Docker Compose

## 目录结构

```
hotel-bi-platform/
├── app/                              # 后端应用
│   ├── api/                          # API路由
│   │   └── v1/                       # API版本1
│   ├── config/                       # 配置文件
│   ├── models/                       # 数据模型
│   ├── schemas/                      # 数据验证模式
│   ├── services/                     # 业务服务层
│   ├── tasks/                        # 异步任务
│   ├── utils/                        # 工具函数
│   └── main.py                       # 应用入口
├── docker/                           # Docker配置
│   ├── nginx/                        # Nginx配置
│   ├── Dockerfile.app                # 应用Docker配置
│   └── docker-compose.yml            # 容器编排配置
├── frontend/                         # 前端应用(待开发)
│   └── src/                          # 前端源码
├── migrations/                       # 数据库迁移脚本
│   ├── versions/                     # 迁移版本
│   ├── env.py                        # 迁移环境配置
│   └── script.py.mako               # 迁移脚本模板
├── scripts/                          # 脚本文件
│   └── init-db.sql                   # 数据库初始化脚本
├── tests/                            # 测试文件(待开发)
├── alembic.ini                       # Alembic配置文件
└── requirements.txt                  # Python依赖
```

## 核心组件说明

### 1. 配置文件

#### 1.1 应用配置 (app/config/settings.py)

包含应用的所有配置参数，包括：
- 应用基本信息
- 数据库连接
- Redis配置
- AI服务配置
- 文件存储配置
- 安全配置
- 上传文件配置
- Celery配置

#### 1.2 数据库配置 (app/config/database.py)

负责数据库连接的建立和管理，包括：
- SQLAlchemy引擎创建
- 会话工厂
- 基础模型类
- 数据库依赖注入

#### 1.3 缓存配置 (app/config/cache.py)

配置Redis缓存服务，包括：
- Redis连接池
- 缓存键生成
- 缓存装饰器
- 缓存管理函数

### 2. 数据模型

#### 2.1 基础模型结构

所有模型直接继承自SQLAlchemy的Base，提供：
- 表名定义
- 主键定义
- 创建和更新时间戳
- 通用的字典转换方法

#### 2.2 核心数据模型

- **酒店数据模型** (app/models/hotel_data.py)：存储酒店基础数据和KPI指标
- **KPI指标模型** (app/models/kpi.py)：存储计算后的KPI指标
- **报告模型** (app/models/report.py)：存储生成的报告信息
- **任务状态模型** (app/models/task.py)：跟踪异步任务的状态和进度

### 3. API路由

#### 3.1 上传API (app/api/v1/upload.py)

处理文件上传功能，支持：
- Excel/CSV文件上传
- 文件验证
- 异步处理任务创建

#### 3.2 数据API (app/api/v1/data.py)

提供数据查询功能，包括：
- 酒店数据查询
- 数据过滤和分页
- 数据统计

#### 3.3 报告API (app/api/v1/reports.py)

管理报告生成和查询：
- 创建报告请求
- 获取报告状态
- 下载报告文件

#### 3.4 仪表盘API (app/api/v1/dashboard.py)

提供仪表盘数据：
- KPI摘要数据
- 趋势分析数据
- 比较分析数据

#### 3.5 任务API (app/api/v1/tasks.py)

管理异步任务：
- 获取任务状态
- 取消任务
- 重试失败任务

### 4. 服务层

#### 4.1 数据服务 (app/services/data_service.py)

处理数据业务逻辑：
- 数据导入和验证
- 数据清洗和转换
- 数据查询和过滤

#### 4.2 KPI服务 (app/services/kpi_service.py)

处理KPI相关业务逻辑：
- KPI计算
- KPI趋势分析
- KPI比较分析

#### 4.3 报告生成服务 (app/services/report_service.py)

处理报告生成相关业务逻辑：
- PDF报告生成（基于Playwright）
- PPT报告生成（基于python-pptx）
- 报告模板应用
- 报告存储和下载链接生成

#### 4.4 任务服务 (app/services/task_service.py)

处理任务相关业务逻辑：
- 任务状态管理
- 任务进度更新
- 任务结果处理

#### 4.5 数据仓库 (app/repositories/data_repository.py)

封装数据库操作：
- 酒店数据存储和查询
- KPI指标计算和存储
- 数据统计和聚合查询
- 趋势和季节性分析

### 5. 异步任务

#### 5.1 Celery配置 (app/tasks/celery_app.py)

配置Celery任务队列：
- Celery应用创建
- 任务路由
- 任务重试策略

#### 5.2 数据处理任务 (app/tasks/data_processing.py)

处理数据相关的异步任务：
- 文件解析
- 数据验证和清洗
- 批量数据导入

#### 5.3 AI分析任务 (app/tasks/ai_analysis.py)

处理AI分析相关的异步任务：
- 准备分析数据
- 构建AI提示词
- 调用DeepSeek API
- 解析AI响应

#### 5.4 报告生成任务 (app/tasks/report_generation.py)

处理报告生成相关的异步任务：
- PDF报告生成
- PPT报告生成
- 报告存储和管理

### 6. 工具函数

#### 6.1 文件处理 (app/utils/file_handler.py)

处理文件操作：
- 文件上传和验证
- MinIO文件存储
- 文件URL生成

#### 6.2 异常处理 (app/utils/exceptions.py)

定义自定义异常类：
- 业务逻辑异常
- 数据验证异常
- 文件处理异常

#### 6.3 数据验证工具 (app/utils/validators.py)

提供全面的数据验证功能：
- 数据类型验证（数值、日期、文本等）
- 字段完整性和格式验证
- 业务规则验证
- 异常值检测
- 数据修正建议

#### 6.4 安全工具 (app/utils/security.py)

提供安全相关功能：
- 密码哈希和验证
- JWT令牌生成和验证
- 输入清理和防XSS
- IP地址验证
- 速率限制
- 数据加密和解密

### 7. Docker配置

#### 7.1 应用Dockerfile (docker/Dockerfile.app)

配置Python应用环境：
- 基础镜像选择
- 依赖安装
- 应用启动命令

#### 7.2 Docker Compose (docker/docker-compose.yml)

配置多容器应用：
- 应用服务
- 工作服务
- PostgreSQL数据库
- Redis缓存
- MinIO文件存储

#### 7.3 Nginx配置 (docker/nginx/default.conf)

配置Web服务器：
- 反向代理设置
- 静态文件服务
- SSL配置(可选)

### 8. 数据库迁移

#### 8.1 Alembic配置 (alembic.ini)

配置数据库迁移工具：
- 迁移脚本位置
- 数据库连接
- 日志配置
- 迁移文件命名模板

#### 8.2 迁移环境 (migrations/env.py)

配置迁移环境：
- 从应用配置获取数据库URL
- 设置目标元数据
- 配置迁移上下文
- 定义迁移函数

#### 8.3 迁移版本 (migrations/versions/)

存储所有数据库迁移脚本：
- 表结构创建
- 字段添加/修改/删除
- 索引管理
- 数据迁移

#### 8.4 迁移命令

常用的Alembic命令：

```bash
# 创建迁移脚本
python -m alembic revision --autogenerate -m "描述迁移内容"

# 应用所有迁移
python -m alembic upgrade head

# 回滚到上一个版本
python -m alembic downgrade -1

# 查看迁移历史
python -m alembic history

# 查看当前版本
python -m alembic current
```

### 9. 数据库初始化

#### 9.1 初始化脚本 (scripts/init-db.sql)

创建数据库表结构：
- 酒店数据表
- KPI指标表
- 报告表
- 任务状态表

## 部署指南

### 1. 环境要求

- Docker & Docker Compose
- 至少2GB RAM
- 10GB可用磁盘空间

### 2. 部署步骤

1. 克隆代码库
   ```bash
   git clone <repository-url>
   cd hotel-bi-platform
   ```

2. 配置环境变量
   ```bash
   cp .env.example .env
   # 编辑.env文件，填入必要的配置参数
   ```

3. 启动服务
   ```bash
   cd docker
   docker-compose up -d
   ```

4. 应用数据库迁移
   ```bash
   python -m alembic upgrade head
   ```

5. 验证部署
   ```bash
   # 检查应用健康状态
   curl http://localhost:8000/health
   ```

## 开发指南

### 1. 本地开发环境设置

1. 安装Python依赖
   ```bash
   pip install -r requirements.txt
   ```

2. 启动数据库和Redis
   ```bash
   cd docker
   docker-compose up -d postgres redis minio
   ```

3. 应用数据库迁移
   ```bash
   python -m alembic upgrade head
   ```

4. 运行应用
   ```bash
   cd ..
   uvicorn app.main:app --reload
   ```

### 2. 数据库模式更改流程

1. 修改模型文件 (app/models/*.py)

2. 生成迁移脚本
   ```bash
   python -m alembic revision --autogenerate -m "描述你的更改"
   ```

3. 检查生成的迁移脚本 (migrations/versions/*)

4. 应用迁移
   ```bash
   python -m alembic upgrade head
   ```

5. 如需回滚，使用
   ```bash
   python -m alembic downgrade -1
   ```

### 3. API文档访问

启动应用后，可以通过以下URL访问API文档：
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## 下一步开发计划

1. 实现前端界面
2. 完善AI分析功能
3. 实现PDF和PPT报告生成
4. 添加单元测试和集成测试
5. 优化用户体验和性能 